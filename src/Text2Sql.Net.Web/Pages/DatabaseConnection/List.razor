@page "/database-connection"
@using SqlSugar
@using Text2Sql.Net.Domain.Model
@using Text2Sql.Net.Repositories.Text2Sql.DatabaseConnection
@using Text2Sql.Net.Repositories.Text2Sql
@using System.Text.Json
@inject IDatabaseConnectionConfigRepository DatabaseConnectionConfigRepository
@inject MessageService MessageService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageContainer Title="æ•°æ®åº“è¿æ¥ç®¡ç†">
    <Extra>
        <Button Type="primary" Icon="plus" @onclick="NavigateToCreate">
            åˆ›å»ºè¿æ¥
        </Button>
    </Extra>
    <Content>
        <div class="search-container">
            <Search Placeholder="è¯·è¾“å…¥è¿æ¥åç§°"
                    EnterButton="@("æœç´¢")"
                    Style="max-width: 522px; width: 100%;"
                    OnSearch="Search" />
        </div>
    </Content>
    <ChildContent>
        <Spin Spinning="@_loading">
            <div class="card-list-container">
                <Row Gutter="24">
                    @foreach (var item in _dataList.Where(x => !string.IsNullOrEmpty(x.Id)))
                    {
                        <AntDesign.Col Xs="24" Sm="12" Md="12" Lg="6" Xl="6" XXl="6">
                            <Card Hoverable Bordered Class="connection-card"
                                  Actions="@(new[] {
                                                use(() => NavigateToChat(item.Id)),
                                                mcp(() => ShowMcpConfig(item.Id)),
                                                info(() => NavigateToDetails(item.Id)),
                                                update(() => NavigateToEdit(item.Id)),
                                                delete(() => DeleteConnection(item.Id))
                                            })">
                            <CardMeta>
                                <AvatarTemplate>
                                        <Avatar Size="large" Icon="database" Style="background-color:#1890ff" />
                                </AvatarTemplate>
                                <TitleTemplate>
                                    <div class="card-title">@item.Name</div>
                                </TitleTemplate>
                                <DescriptionTemplate>
                                    <div class="card-description">
                                        <Tag Color="@GetDbTypeColor(item.DbType)">@item.DbType</Tag>
                                        <div class="create-time">åˆ›å»ºæ—¶é—´: @(item.CreateTime.ToString("yyyy-MM-dd"))</div>
                                    </div>
                                </DescriptionTemplate>
                            </CardMeta>
                        </Card>
                    </AntDesign.Col>
                    }
                </Row>
                
                @if (!_dataList.Any() || _dataList.Count == 1 && string.IsNullOrEmpty(_dataList[0].Id))
                {
                    <Empty Description="@("æš‚æ— æ•°æ®è¿æ¥")">
                        <Button Type="primary" Icon="plus" @onclick="NavigateToCreate">
                            åˆ›å»ºè¿æ¥
                        </Button>
                    </Empty>
                }
            </div>
        </Spin>
    </ChildContent>
</PageContainer>

@* MCPé…ç½®æ¨¡æ€æ¡† *@
<Modal Title="@($"MCP è¿æ¥é…ç½® - {_selectedConnectionName}")"
       Visible="_mcpModalVisible"
       OnOk="HandleMcpOk"
       OnCancel="HandleMcpCancel"
       Width="800">
    <div class="mcp-config-container">
        <Alert Type="@AlertType.Info" 
               ShowIcon="true"
               Message="å…³äº MCP (Model Context Protocol)"
               Description="@($"MCP æ˜¯ä¸€ä¸ªæ ‡å‡†åŒ–åè®®ï¼Œå¯ä»¥è®©AIå·¥å…·ï¼ˆå¦‚Cursorã€Traeç­‰IDEï¼‰ç›´æ¥è°ƒç”¨æ­¤æ•°æ®åº“è¿æ¥ï¼ˆ{_selectedConnectionName}ï¼‰çš„Text2SqlåŠŸèƒ½ã€‚é…ç½®åï¼Œæ‚¨å¯ä»¥åœ¨IDEä¸­é€šè¿‡è‡ªç„¶è¯­è¨€ç”ŸæˆSQLæŸ¥è¯¢ã€‚")" 
               Style="margin-bottom: 16px;" />
        
        <div class="config-section">
            <Title Level="4">é…ç½®ä¿¡æ¯</Title>
            <div class="config-item">
                <Text Strong>æ•°æ®åº“è¿æ¥ï¼š</Text>
                <Text Code>@_selectedConnectionName</Text>
            </div>
            
            <div class="config-item">
                <Text Strong>è¿æ¥IDï¼š</Text>
                <Text Code>@_selectedConnectionId</Text>
                <Button Type="link" Size="small" Icon="copy" @onclick="CopyConnectionIdToClipboard">å¤åˆ¶</Button>
            </div>
            
            <div class="config-item">
                <Text Strong>MCPé…ç½®JSONï¼š</Text>
                <div class="json-container">
                    <pre class="json-code">@_mcpConfigJson</pre>
                    <Button Type="primary" Size="small" Icon="copy" @onclick="CopyJsonToClipboard" Style="position: absolute; top: 8px; right: 8px;">
                        å¤åˆ¶é…ç½®
                    </Button>
                </div>
            </div>
        </div>
        
        <div class="usage-section">
            <Title Level="4">ä½¿ç”¨è¯´æ˜</Title>
            <div class="steps-container">
                <div class="step-item">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">å¤åˆ¶é…ç½®</div>
                        <div class="step-description">ç‚¹å‡»ä¸Šæ–¹"å¤åˆ¶é…ç½®"æŒ‰é’®ï¼Œå¤åˆ¶MCPæœåŠ¡å™¨é…ç½®JSON</div>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">é…ç½®IDE</div>
                        <div class="step-description">åœ¨Cursorã€Traeç­‰IDEçš„MCPè®¾ç½®ä¸­ç²˜è´´é…ç½®</div>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-title">å¼€å§‹ä½¿ç”¨</div>
                        <div class="step-description">åœ¨IDEä¸­é€šè¿‡è‡ªç„¶è¯­è¨€æè¿°æ‚¨çš„æ•°æ®æŸ¥è¯¢éœ€æ±‚</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="features-section">
            <Title Level="4">å¯ç”¨åŠŸèƒ½</Title>
            <Row Gutter="16">
                <AntDesign.Col Span="12">
                    <Card Size="small">
                        <CardMeta>
                            <TitleTemplate>ğŸ” æ™ºèƒ½æŸ¥è¯¢</TitleTemplate>
                            <DescriptionTemplate>å°†è‡ªç„¶è¯­è¨€è½¬æ¢ä¸ºSQLæŸ¥è¯¢</DescriptionTemplate>
                        </CardMeta>
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="12">
                    <Card Size="small">
                        <CardMeta>
                            <TitleTemplate>ğŸ“Š æ•°æ®æ‰§è¡Œ</TitleTemplate>
                            <DescriptionTemplate>ç›´æ¥æ‰§è¡ŒSQLå¹¶æŸ¥çœ‹ç»“æœ</DescriptionTemplate>
                        </CardMeta>
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="12">
                    <Card Size="small">
                        <CardMeta>
                            <TitleTemplate>ğŸ—„ï¸ æ¶æ„ä¿¡æ¯</TitleTemplate>
                            <DescriptionTemplate>è·å–æ•°æ®åº“è¡¨ç»“æ„ä¿¡æ¯</DescriptionTemplate>
                        </CardMeta>
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="12">
                    <Card Size="small">
                        <CardMeta>
                            <TitleTemplate>ğŸ’¬ å†å²è®°å½•</TitleTemplate>
                            <DescriptionTemplate>æŸ¥çœ‹èŠå¤©å’ŒæŸ¥è¯¢å†å²</DescriptionTemplate>
                        </CardMeta>
                    </Card>
                </AntDesign.Col>
            </Row>
        </div>
    </div>
</Modal>

<style>
    .search-container {
        text-align: center;
    }
    
    .card-list-container {
        padding: 24px;
        background-color: #f0f2f5;
        border-radius: 8px;
        min-height: 300px;
    }
    
    .connection-card {
        border-radius: 8px;
        transition: all 0.3s;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.09);
    }
    
    .connection-card:hover {
        box-shadow: 0 8px 16px rgba(24, 144, 255, 0.2);
        transform: translateY(-4px);
        border-color: #1890ff;
    }
    
    .card-title {
        font-size: 16px;
        font-weight: 500;
        color: rgba(0, 0, 0, 0.85);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .card-description {
        margin-top: 12px;
    }
    
    .create-time {
        margin-top: 8px;
        font-size: 12px;
        color: rgba(0, 0, 0, 0.45);
    }
    
    .mcp-config-container {
        padding: 8px 0;
    }
    
    .config-section {
        margin-bottom: 24px;
    }
    
    .config-item {
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .json-container {
        position: relative;
        background: #f6f8fa;
        border: 1px solid #d1d9e0;
        border-radius: 6px;
        margin-top: 8px;
        width: 100%;
    }
    
    .json-code {
        margin: 0;
        padding: 16px;
        background: transparent;
        border: none;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        font-size: 13px;
        line-height: 1.4;
        color: #24292f;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-x: auto;
    }
    
    .usage-section, .features-section {
        margin-bottom: 16px;
    }
    
    .steps-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    
    .step-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }
    
    .step-number {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #1890ff;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        flex-shrink: 0;
    }
    
    .step-content {
        flex: 1;
    }
    
    .step-title {
        font-weight: 500;
        margin-bottom: 4px;
        color: rgba(0, 0, 0, 0.85);
    }
    
    .step-description {
        font-size: 13px;
        color: rgba(0, 0, 0, 0.65);
        line-height: 1.4;
    }
</style>

@code {
    RenderFragment use(Action clickAction) =>@<a key="use" @onclick="@clickAction" style="color: #1890ff; font-weight: 500;">ä½¿ç”¨</a>;
    RenderFragment mcp(Action clickAction) =>@<a key="mcp" @onclick="@clickAction" style="color: #52c41a;">MCP</a>;
    RenderFragment info(Action clickAction) =>@<a key="info" @onclick="@clickAction">æŸ¥çœ‹</a>;
    RenderFragment update(Action clickAction) =>@<a key="edit" @onclick="@clickAction">ç¼–è¾‘</a>;
    RenderFragment delete(Func<Task> clickAction) => @<a key="delete" @onclick="@clickAction">åˆ é™¤</a> ;


    private List<DatabaseConnectionConfig> _dataList = new List<DatabaseConnectionConfig>();
    private bool _loading = false;
    private int _total = 0;
    private bool _mcpModalVisible = false;
    private string _currentHostUrl = "";
    private string _mcpConfigJson = "";
    private string _selectedConnectionId = "";
    private string _selectedConnectionName = "";

    protected override async Task OnInitializedAsync()
    {
        await InitData("");
        _currentHostUrl = NavigationManager.BaseUri.TrimEnd('/');
    }

    private async Task InitData(string searchKey)
    {
        _loading = true;
        try
        {
            var exp = Expressionable.Create<DatabaseConnectionConfig>();
            exp.AndIF(!string.IsNullOrEmpty(searchKey), p => p.Name.Contains(searchKey));
            var data = await DatabaseConnectionConfigRepository.GetListAsync(exp.ToExpression());
            _dataList = data.OrderByDescending(x => x.CreateTime).ToList();
            _total = _dataList.Count;
        }
        catch (Exception ex)
        {
            _= MessageService.Error($"åŠ è½½æ•°æ®å¤±è´¥: {ex.Message}", 2);
        }
        finally
        {
            _loading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task Search(string searchKey)
    {
        await InitData(searchKey);
    }

    private void NavigateToCreate()
    {
        NavigationManager.NavigateTo($"/database-connection/create");
    }

    private void NavigateToDetails(string id)
    {
        NavigationManager.NavigateTo($"/database-connection/details/{id}");
    }

    private void NavigateToEdit(string id)
    {
        NavigationManager.NavigateTo($"/database-connection/create/{id}");
    }

    private void NavigateToChat(string id)
    {
        NavigationManager.NavigateTo($"/database-chat?connectionId={id}");
    }

    private async Task DeleteConnection(string id)
    {
        try
        {
            var success = await DatabaseConnectionConfigRepository.DeleteAsync(id);
            if (success)
            {
                _= MessageService.Success("åˆ é™¤æˆåŠŸ");
                await InitData("");
            }
            else
            {
                _= MessageService.Error("åˆ é™¤å¤±è´¥");
            }
        }
        catch (Exception ex)
        {
            _= MessageService.Error($"åˆ é™¤å¤±è´¥: {ex.Message}");
        }
    }
    
    private string GetDbTypeColor(string dbType)
    {
        return dbType?.ToLower() switch
        {
            "mysql" => "green",
            "sqlserver" => "blue",
            "oracle" => "red",
            "postgresql" => "purple",
            "sqlite" => "orange",
            "dm" => "cyan",
            "kingbasees" => "gold",
            "clickhouse" => "volcano",
            "opengauss" => "magenta",
            _ => "geekblue"
        };
    }
    
    private void ShowMcpConfig(string connectionId)
    {
        _selectedConnectionId = connectionId;
        var connection = _dataList.FirstOrDefault(c => c.Id == connectionId);
        _selectedConnectionName = connection?.Name ?? "æœªçŸ¥è¿æ¥";
        
        var mcpConfig = new
        {
            mcpServers = new Dictionary<string, object>
            {
                [$"text2sql"] = new
                {
                    name = $"Text2Sql.Net - {_selectedConnectionName}",
                    type = "sse",
                    description = $"æ™ºèƒ½Text2SQLæœåŠ¡ - ã€‚æ”¯æŒè‡ªç„¶è¯­è¨€è½¬SQLæŸ¥è¯¢ã€‚å…¼å®¹Cursorã€Traeç­‰IDEã€‚",
                    isActive = true,
                    url = $"{_currentHostUrl}/mcp/sse?connectionId={connectionId}"
                }
            }
        };
        
        _mcpConfigJson = JsonSerializer.Serialize(mcpConfig, new JsonSerializerOptions 
        { 
            WriteIndented = true,
            Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
        });
        
        _mcpModalVisible = true;
    }
    
    private void HandleMcpOk()
    {
        _mcpModalVisible = false;
    }
    
    private void HandleMcpCancel()
    {
        _mcpModalVisible = false;
    }
    
    private async Task CopyConnectionIdToClipboard()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _selectedConnectionId);
            _ = MessageService.Success("è¿æ¥IDå·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        }
        catch
        {
            _ = MessageService.Error("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
        }
    }
    
    private async Task CopyJsonToClipboard()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _mcpConfigJson);
            _ = MessageService.Success("MCPé…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        }
        catch
        {
            _ = MessageService.Error("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶");
        }
    }
} 